<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Boss Test Suite</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff88;
            text-align: center;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 10px;
        }
        .test-section {
            background: #1a1a1a;
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h2 {
            color: #ffaa00;
            margin-top: 0;
        }
        button {
            background: #00ff88;
            color: #0a0a0a;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00cc66;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .output {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            color: #00ff00;
        }
        .error {
            color: #ff0000;
        }
        .warning {
            color: #ffaa00;
        }
        .info {
            color: #00aaff;
        }
        .loading {
            color: #ffaa00;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-pending {
            background: #666;
        }
        .status-running {
            background: #ffaa00;
            animation: pulse 1s infinite;
        }
        .status-success {
            background: #00ff00;
        }
        .status-error {
            background: #ff0000;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <h1>ü§ñ AI BOSS - Test Suite</h1>
    <p style="text-align: center; color: #888;">
        Testing AI Boss Phase 1 Backend Functions<br>
        Project: rapidpro-memphis
    </p>

    <!-- Test 1: Analyze Hot Lead -->
    <div class="test-section">
        <h2><span id="test1-status" class="status-indicator status-pending"></span>Test 1: Hot Lead Analysis</h2>
        <p>Scenario: Manager with urgent refrigeration issue (food safety concern)</p>
        <button id="test1-btn" onclick="runTest1()">Run Test 1</button>
        <button onclick="clearOutput('test1-output')">Clear Output</button>
        <div id="test1-output" class="output">Waiting for test to run...</div>
    </div>

    <!-- Test 2: Analyze Warm Lead -->
    <div class="test-section">
        <h2><span id="test2-status" class="status-indicator status-pending"></span>Test 2: Warm Lead Analysis</h2>
        <p>Scenario: Manager interested, wants callback on specific day</p>
        <button id="test2-btn" onclick="runTest2()">Run Test 2</button>
        <button onclick="clearOutput('test2-output')">Clear Output</button>
        <div id="test2-output" class="output">Waiting for test to run...</div>
    </div>

    <!-- Test 3: Analyze Rejection -->
    <div class="test-section">
        <h2><span id="test3-status" class="status-indicator status-pending"></span>Test 3: Rejection Analysis</h2>
        <p>Scenario: Already has vendor, not interested</p>
        <button id="test3-btn" onclick="runTest3()">Run Test 3</button>
        <button onclick="clearOutput('test3-output')">Clear Output</button>
        <div id="test3-output" class="output">Waiting for test to run...</div>
    </div>

    <!-- Test 4: Get AI Command -->
    <div class="test-section">
        <h2><span id="test4-status" class="status-indicator status-pending"></span>Test 4: Get Current AI Command</h2>
        <p>Get what the AI wants the tech to do RIGHT NOW</p>
        <button id="test4-btn" onclick="runTest4()">Run Test 4</button>
        <button onclick="clearOutput('test4-output')">Clear Output</button>
        <div id="test4-output" class="output">Waiting for test to run...</div>
    </div>

    <!-- Test 5: Get Scheduled Actions -->
    <div class="test-section">
        <h2><span id="test5-status" class="status-indicator status-pending"></span>Test 5: List Scheduled Actions</h2>
        <p>View all upcoming scheduled follow-ups</p>
        <button id="test5-btn" onclick="runTest5()">Run Test 5</button>
        <button onclick="clearOutput('test5-output')">Clear Output</button>
        <div id="test5-output" class="output">Waiting for test to run...</div>
    </div>

    <!-- Run All Tests -->
    <div class="test-section" style="background: #2a2a2a; border-color: #ffaa00;">
        <h2>üöÄ Run All Tests</h2>
        <div class="test-grid">
            <button onclick="runAllTests()" style="background: #ffaa00; font-size: 18px; padding: 15px;">‚ñ∂ Run All Tests</button>
            <button onclick="clearAllOutputs()" style="background: #666;">Clear All Outputs</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

    <!-- Firebase Config -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHQvQDtU-L3yy5VrDFBqeQBaLd9Vxwq8A",
            authDomain: "rapidpro-memphis.firebaseapp.com",
            projectId: "rapidpro-memphis",
            storageBucket: "rapidpro-memphis.firebasestorage.app",
            messagingSenderId: "161871881939",
            appId: "1:161871881939:web:9d64d42a5f57b46e4bfa95"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const functions = firebase.functions();
        const auth = firebase.auth();

        // Sign in anonymously for testing
        auth.signInWithEmailAndPassword("test@rapidpro.com", "testpassword123").catch(() => auth.signInAnonymously()).then(() => {
            log('info', 'test1-output', '‚úÖ Authenticated with Firebase');
        }).catch(err => {
            log('error', 'test1-output', '‚ùå Auth error: ' + err.message);
        });

        // Utility functions
        function log(type, outputId, message) {
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput(outputId) {
            document.getElementById(outputId).innerHTML = '';
        }

        function clearAllOutputs() {
            ['test1-output', 'test2-output', 'test3-output', 'test4-output', 'test5-output'].forEach(id => {
                clearOutput(id);
            });
        }

        function setTestStatus(testNum, status) {
            const statusEl = document.getElementById(`test${testNum}-status`);
            statusEl.className = `status-indicator status-${status}`;
        }

        function disableButton(buttonId, disabled = true) {
            document.getElementById(buttonId).disabled = disabled;
        }

        // Test 1: Hot Lead Analysis
        async function runTest1() {
            const outputId = 'test1-output';
            clearOutput(outputId);
            setTestStatus(1, 'running');
            disableButton('test1-btn');

            log('info', outputId, 'üß™ Starting Test 1: Hot Lead Analysis');
            log('info', outputId, 'Scenario: Manager with urgent walk-in cooler failure (food safety issue)');
            log('loading', outputId, '‚è≥ Calling analyzeInteraction...');

            try {
                const analyzeInteraction = functions.httpsCallable('analyzeInteraction');
                const result = await analyzeInteraction({
                    locationId: 'test-hot-lead-001',
                    note: 'Manager Sarah said she needs refrigeration maintenance ASAP. Walk-in cooler making loud grinding noise and temperature rising. Very concerned about food safety and health inspection tomorrow.',
                    efficacyScore: 5,
                    timestamp: new Date().toISOString()
                });

                log('success', outputId, '‚úÖ AI Boss responded successfully!');
                log('info', outputId, '\nüìä RESPONSE DATA:');
                log('info', outputId, JSON.stringify(result.data, null, 2));

                log('info', outputId, '\nü§ñ AI ANALYSIS:');
                log('success', outputId, result.data.analysis);

                log('info', outputId, '\n‚ö° IMMEDIATE ACTION:');
                log('warning', outputId, result.data.immediateAction);

                if (result.data.scheduledAction) {
                    log('info', outputId, '\n‚è∞ SCHEDULED FOLLOW-UP:');
                    log('warning', outputId, `Time: ${result.data.scheduledAction.time}`);
                    log('warning', outputId, `Action: ${result.data.scheduledAction.action}`);
                    log('warning', outputId, `Reason: ${result.data.scheduledAction.reason}`);
                }

                log('info', outputId, '\nüéØ LEAD PRIORITY:');
                log('success', outputId, result.data.leadPriority.toUpperCase());

                log('info', outputId, '\nüí¨ AI COMMAND:');
                log('success', outputId, result.data.aiCommand);

                setTestStatus(1, 'success');
            } catch (error) {
                log('error', outputId, '‚ùå Test failed: ' + error.message);
                log('error', outputId, error.stack || '');
                setTestStatus(1, 'error');
            } finally {
                disableButton('test1-btn', false);
            }
        }

        // Test 2: Warm Lead Analysis
        async function runTest2() {
            const outputId = 'test2-output';
            clearOutput(outputId);
            setTestStatus(2, 'running');
            disableButton('test2-btn');

            log('info', outputId, 'üß™ Starting Test 2: Warm Lead Analysis');
            log('info', outputId, 'Scenario: Manager interested, requests callback on Friday');
            log('loading', outputId, '‚è≥ Calling analyzeInteraction...');

            try {
                const analyzeInteraction = functions.httpsCallable('analyzeInteraction');
                const result = await analyzeInteraction({
                    locationId: 'test-warm-lead-002',
                    note: 'Spoke to manager Steve. He said their current refrigeration service is inconsistent. Interested in hearing about our preventative maintenance plans. Asked me to call back Friday afternoon between 2-4 PM when he has more time to discuss.',
                    efficacyScore: 4,
                    timestamp: new Date().toISOString()
                });

                log('success', outputId, '‚úÖ AI Boss responded successfully!');
                log('info', outputId, '\nüìä RESPONSE DATA:');
                log('info', outputId, JSON.stringify(result.data, null, 2));

                log('info', outputId, '\nü§ñ AI ANALYSIS:');
                log('success', outputId, result.data.analysis);

                log('info', outputId, '\n‚ö° IMMEDIATE ACTION:');
                log('warning', outputId, result.data.immediateAction);

                if (result.data.scheduledAction) {
                    log('info', outputId, '\n‚è∞ SCHEDULED FOLLOW-UP:');
                    log('warning', outputId, `Time: ${result.data.scheduledAction.time}`);
                    log('warning', outputId, `Action: ${result.data.scheduledAction.action}`);
                    log('warning', outputId, `Reason: ${result.data.scheduledAction.reason}`);
                }

                log('info', outputId, '\nüéØ LEAD PRIORITY:');
                log('success', outputId, result.data.leadPriority.toUpperCase());

                log('info', outputId, '\nüí¨ AI COMMAND:');
                log('success', outputId, result.data.aiCommand);

                setTestStatus(2, 'success');
            } catch (error) {
                log('error', outputId, '‚ùå Test failed: ' + error.message);
                log('error', outputId, error.stack || '');
                setTestStatus(2, 'error');
            } finally {
                disableButton('test2-btn', false);
            }
        }

        // Test 3: Rejection Analysis
        async function runTest3() {
            const outputId = 'test3-output';
            clearOutput(outputId);
            setTestStatus(3, 'running');
            disableButton('test3-btn');

            log('info', outputId, 'üß™ Starting Test 3: Rejection Analysis');
            log('info', outputId, 'Scenario: Already has vendor under contract');
            log('loading', outputId, '‚è≥ Calling analyzeInteraction...');

            try {
                const analyzeInteraction = functions.httpsCallable('analyzeInteraction');
                const result = await analyzeInteraction({
                    locationId: 'test-rejection-003',
                    note: 'Spoke to owner Mike. He said they already have a refrigeration company under contract for the next 2 years. Very happy with their current service. Not interested in switching.',
                    efficacyScore: 1,
                    timestamp: new Date().toISOString()
                });

                log('success', outputId, '‚úÖ AI Boss responded successfully!');
                log('info', outputId, '\nüìä RESPONSE DATA:');
                log('info', outputId, JSON.stringify(result.data, null, 2));

                log('info', outputId, '\nü§ñ AI ANALYSIS:');
                log('success', outputId, result.data.analysis);

                log('info', outputId, '\n‚ö° IMMEDIATE ACTION:');
                log('warning', outputId, result.data.immediateAction);

                if (result.data.scheduledAction) {
                    log('info', outputId, '\n‚è∞ SCHEDULED FOLLOW-UP:');
                    log('warning', outputId, `Time: ${result.data.scheduledAction.time}`);
                    log('warning', outputId, `Action: ${result.data.scheduledAction.action}`);
                    log('warning', outputId, `Reason: ${result.data.scheduledAction.reason}`);
                }

                log('info', outputId, '\nüéØ LEAD PRIORITY:');
                log('success', outputId, result.data.leadPriority.toUpperCase());

                log('info', outputId, '\nüí¨ AI COMMAND:');
                log('success', outputId, result.data.aiCommand);

                setTestStatus(3, 'success');
            } catch (error) {
                log('error', outputId, '‚ùå Test failed: ' + error.message);
                log('error', outputId, error.stack || '');
                setTestStatus(3, 'error');
            } finally {
                disableButton('test3-btn', false);
            }
        }

        // Test 4: Get AI Command
        async function runTest4() {
            const outputId = 'test4-output';
            clearOutput(outputId);
            setTestStatus(4, 'running');
            disableButton('test4-btn');

            log('info', outputId, 'üß™ Starting Test 4: Get Current AI Command');
            log('info', outputId, 'Getting tactical guidance for what to do RIGHT NOW');
            log('loading', outputId, '‚è≥ Calling getAICommand...');

            try {
                const getAICommand = functions.httpsCallable('getAICommand');
                const result = await getAICommand();

                log('success', outputId, '‚úÖ AI Command received!');
                log('info', outputId, '\nüìä RESPONSE DATA:');
                log('info', outputId, JSON.stringify(result.data, null, 2));

                log('info', outputId, '\nüéØ COMMAND TYPE:');
                log('success', outputId, result.data.type);

                if (result.data.urgency) {
                    log('info', outputId, '\n‚ö†Ô∏è URGENCY LEVEL:');
                    log('warning', outputId, result.data.urgency);
                    log('warning', outputId, `Minutes until due: ${result.data.minutesUntil}`);
                }

                log('info', outputId, '\nüí¨ AI COMMAND:');
                log('success', outputId, result.data.command);

                setTestStatus(4, 'success');
            } catch (error) {
                log('error', outputId, '‚ùå Test failed: ' + error.message);
                log('error', outputId, error.stack || '');
                setTestStatus(4, 'error');
            } finally {
                disableButton('test4-btn', false);
            }
        }

        // Test 5: Get Scheduled Actions
        async function runTest5() {
            const outputId = 'test5-output';
            clearOutput(outputId);
            setTestStatus(5, 'running');
            disableButton('test5-btn');

            log('info', outputId, 'üß™ Starting Test 5: List Scheduled Actions');
            log('info', outputId, 'Retrieving all upcoming scheduled follow-ups');
            log('loading', outputId, '‚è≥ Calling getScheduledActions...');

            try {
                const getScheduledActions = functions.httpsCallable('getScheduledActions');
                const result = await getScheduledActions();

                log('success', outputId, '‚úÖ Scheduled actions retrieved!');
                log('info', outputId, '\nüìä RESPONSE DATA:');
                log('info', outputId, JSON.stringify(result.data, null, 2));

                if (result.data.actions && result.data.actions.length > 0) {
                    log('info', outputId, `\nüìÖ FOUND ${result.data.actions.length} SCHEDULED ACTION(S):`);
                    result.data.actions.forEach((action, index) => {
                        log('info', outputId, `\n--- Action ${index + 1} ---`);
                        log('success', outputId, `Location: ${action.locationName}`);
                        log('success', outputId, `Scheduled: ${new Date(action.scheduledTime).toLocaleString()}`);
                        log('success', outputId, `Action: ${action.action}`);
                        log('success', outputId, `Reason: ${action.reason}`);
                        log('success', outputId, `Status: ${action.status}`);
                    });
                } else {
                    log('warning', outputId, '\n‚ö†Ô∏è No scheduled actions found');
                    log('info', outputId, 'This is expected if you haven\'t run the analysis tests yet.');
                    log('info', outputId, 'Run Test 1 or Test 2 first to create scheduled actions.');
                }

                setTestStatus(5, 'success');
            } catch (error) {
                log('error', outputId, '‚ùå Test failed: ' + error.message);
                log('error', outputId, error.stack || '');
                setTestStatus(5, 'error');
            } finally {
                disableButton('test5-btn', false);
            }
        }

        // Run all tests sequentially
        async function runAllTests() {
            log('info', 'test1-output', 'üöÄ Running all tests sequentially...\n');

            await runTest1();
            await new Promise(resolve => setTimeout(resolve, 2000));

            await runTest2();
            await new Promise(resolve => setTimeout(resolve, 2000));

            await runTest3();
            await new Promise(resolve => setTimeout(resolve, 2000));

            await runTest4();
            await new Promise(resolve => setTimeout(resolve, 2000));

            await runTest5();

            alert('‚úÖ All tests complete! Check the outputs above.');
        }
    </script>
</body>
</html>
